class: middle center

# Lua 104

> Harder better faster stronger

---

# Contents

- Pattern captures
- User input
- Records

---

class: middle

# Pattern captures

> The photograph itself doesn't interest me. I want only to capture a minute part of reality. (Henri Cartier-Bresson)

![Henri Carter-Bresson](http://graphics8.nytimes.com/images/2013/06/20/blogs/20130620-lens-bresson-slide-IVP4/20130620-lens-bresson-slide-IVP4-superJumbo.jpg)

---

# Captures

In a pattern, we can define *captures*: parts of the patterns enclosed in parentheses `()`. When the pattern matches, the substrings that correspond to captures are stored ("captured") for future use.

The pattern `"(%w+) = (%d+)"` has two captures. The first one is `%w+` and the second one is `%d+`.

Depending on the function we use, captures have different effects.

---

# Captures in `string.match()`

If the pattern passed to `string.match()` contains captures, and the pattern matched, the captured strings are returned.

```lua
-- looking for a word following "Hello":
s = "Hello world!"

capture = string.match(s, "Hello (%a+)")
print(capture)
```

**Reminder:** without captures, the whole match is returned:

```lua
-- looking for a word following "Hello":
s = "Hello world!"

match = string.match(s, "Hello %a+")
print(match)
```

---

# Multiple captures

When multiple captures are defined, they are all returned:

```lua
s = "My birthday is the 02/09/1987"

day, month, year = string.match(s, "(%d%d)/(%d%d)/(%d%d%d%d)")
print(day, month, year)
```

**Note:** the matches are always strings. To convert strings into the numbers they represent, use the `tonumber()` function:

```lua
s = "1029"
n = tonumber(s)
print(n > 1000)	--> true
print(s > 1000)	--> error!
```

---

# Captures and `string.find()`

When passing a pattern with captures to `string.find()`, the captures are returned after the indices of start and end of the match.

```lua
s = "My birthday is the 02/09/1987"

start, finish, day, month, year = string.find(s, "(%d%d)/(%d%d)/(%d%d%d%d)")
print("Found date at:", start, finish)
print("Date was:", day, month, year)
```

---

# Nested captures

Captures can be nested (contain other captures), in which case they are returned in the order of their opening parentheses `(`:

```lua
s = "I found a bunny rabbit"

-- looking for a sequence of two words, following "a ",
-- the first one starting in b
both, first, second = string.match(s, "a ((b%a*) (%a+))")
print(both)
print(first, second)
```

---

# Using capture results in patterns

The result of a capture can be used in the pattern itself: the special sequence `%i` (where `i` is a digit from 1 to 9) represents the text that was matched by the `i`-th capture:

```lua
s = "I accidentally wrote the the same word twice."

word = string.match(s, "(%a+) %1")
print("Repeated word: " .. word)
```

---

# Captures and `string.gsub()`

When defining captures in a pattern passed to `string.gsub()`, you can use the `%i` sequences in the replacement string. Additionally, `%0` represents the whole match:

```lua
s = "My pretty little string."

-- duplicate every word
print(string.gsub(s, "%a+", "%0 %0"))
--> My My pretty pretty little little string string.	4

-- swap letters around spaces
print(string.gsub(s, "(%a) (%a)", "%2 %1"))
--> Mp yrettl yittls etring.	3

-- enclose every double letter in underscores
print(string.gsub(s, "(%a)%1", "_%0_"))
--> My pre_tt_y li_tt_le string.	2
```

---

# `string.gmatch()`

Used with the generic for loop `for in end`, will iterate over all matches of the pattern in a given string:

```lua
s = "I lost the stupid soot."
for word in string.gmatch(s, "%a+") do
	print(word)
end
```

If the pattern defines captures, they are all returned:

```lua
s = "I played A2, they played F17"
for row, column in string.gmatch(s, "(%a)(%d+)") do
	print(row, column)
end
```

---

# `io.lines()`

Used in a generic for loop, reads an entire file line by line:

```lua
for line in io.lines("somefile.txt") do
	print(line)
end
```

---

# Exercises: database processing

The file [clients.csv][exercises/clients/clients.csv] contains a database of clients, in the CSV format (comma separated values):

```
Username;GivenName;Surname;Gender;StreetAddress;City;CountryFull;EmailAddress;TelephoneNumber;Birthday;Occupation
Vess1987;Naruki;Taniguchi;male;Avenida Boavista 47;Costinha;Portugal;NarukiTaniguchi@superrito.com;21 258 497 1191;5/10/1987;U.S. Border Patrol agent
Blis1991;David;Kristensen;male;Aia 53;Pärsikivi;Estonia;DavidKristensen@dayrep.com;709 6942;5/11/1991;Electronics engineer
Itoponed;Jana;Salabová;female;503 Woodridge Lane;Memphis;United States;JanaSalabova@einrot.com;901-405-1472;1/20/1947;Contract administrator
Yousintor;Legget;Gousse;male;Χάριτος 211;ΙΝΕΙΑ;Cyprus (Greek);LeggetGousse@armyspy.com;26 172282;11/10/1958;Precision instrument and equipment repairer
Honpon;هومان;میرهاشمی;male;Grýtubakki 82;Vík;Iceland;HewmanMarhashema@superrito.com;485 2680;12/27/1987;Credit analyst
Casits;Darko;Crnić;male;1493 Glyn St;Pretoria;South Africa;DarkoCrnic@armyspy.com;082 647 7669;5/18/1968;Handymen
```

---

# Loading the database

First, write a function `split(s)` that splits a string `s` into substrings separated by the character `;`: for instance, `split("foo;bar;baz;meh")` would return the array `{"foo","bar","baz","meh"}`. There are several ways to do that, using `string.find()` or `string.`gmatch()`.

Then, write a function `load_database()` that:

- Reads all lines of the CSV file, using `io.lines()`
- Splits each line into individual fields.
- In each line, gathers the data fields into a table with keys `Username`, `GivenName`, etc. (which are the fields of the first line).
- Saves all the tables in an array, and returns it.

Once done, you should be able to get the data as follows:

```lua
-- Print the address of client 243
local clients = load_database()
print(#clients)						 --> 50000
print(clients[243]["StreetAddress"]) --> "Byggðavegur 80"
```

---

# Questions

All these functions should take as parameter the list of clients as returned by `load_database()`.

- Write a function `count_genders(clients)` that returns the number of men and women in the database
- Write a function `average_age(clients)` that returns the average age of the clients
	- you can deduce the age from the birthday
	- if needed, use `tonumber()` to convert a string into the number it represents
- Modify the previous function to also return the median age
	- gather all ages in an array
	- sort the array using `table.sort(array)`
	- return the middle element
- Write a `photo(client)` function that prints the username and job of all clients in Tunisia that have something to do with photography (ie. they occupation contains "photo")
	- you can use `string.lower(s)` to get a lowercase version of string `s`
- Using this dummy email function:
	```lua
	function email(address, message)
		print("Email to " .. address .. ": " .. message)
	end
	```
	write a function `birthdays(clients)` that sends a personalised "Happy birthday" email to everyone whose birthday it is today.
	- The function `os.date()` returns a string that contains the current date (warning: OS dependent)
- Write a function `countries_stats(clients)` that prints how many client we have in each country